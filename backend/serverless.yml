service: ehr-backend-api

frameworkVersion: "3"

useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-southeast-1
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30

  environment:
    USER_POOL_ID: ${env:USER_POOL_ID}
    CLIENT_ID: ${env:CLIENT_ID}
    REGION: ${env:REGION}
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: "Hai12345"
    JWT_SECRET: ${self:custom.JWT_SECRET}
    WEBAUTHN_RP_ID: ${env:WEBAUTHN_RP_ID, 'localhost'}
    WEBAUTHN_ORIGIN: ${env:WEBAUTHN_ORIGIN, 'http://localhost:3000'}
    SES_FROM_EMAIL: ${env:SES_FROM_EMAIL, 'phuchai5904@gmail.com'}
    NODE_ENV: ${self:provider.stage}
    DEPLOY_TS: 2026-01-02-113800

    # ADDED
    PATIENT_FILES_BUCKET: ehr-backend-api-patient-files-dev

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"

        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:ListUsers
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminAddUserToGroup
            - cognito-idp:AdminDisableUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:AdminListGroupsForUser
          Resource:
            - arn:aws:cognito-idp:${self:provider.region}:*:userpool/${env:USER_POOL_ID}

        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource:
            - arn:aws:secretsmanager:${self:provider.region}:*:secret:ehr-system/*

        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

        # ADDED S3 PERMISSIONS
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::ehr-backend-api-patient-files-dev
            - arn:aws:s3:::ehr-backend-api-patient-files-dev/*

  httpApi:
    cors:
      allowedOrigins:
        - "*"
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS

plugins:
  - serverless-offline
  - serverless-dotenv-plugin

custom:
  JWT_SECRET: EHR_SYSTEM_WEBAUTHN_SECRET_KEY_2025_SECURE_TOKEN_CHANGE_IN_PRODUCTION

functions:
  # ===== WEBAUTHN =====
  webauthnRegisterStart:
    handler: handlers/webauthn.startRegistration
    events:
      - httpApi:
          path: /webauthn/register/start
          method: post

  webauthnRegisterFinish:
    handler: handlers/webauthn.finishRegistration
    events:
      - httpApi:
          path: /webauthn/register/finish
          method: post

  webauthnAuthStart:
    handler: handlers/webauthn.startAuthentication
    events:
      - httpApi:
          path: /webauthn/auth/start
          method: post

  webauthnAuthFinish:
    handler: handlers/webauthn.finishAuthentication
    events:
      - httpApi:
          path: /webauthn/auth/finish
          method: post

  webauthnGetCredentials:
    handler: handlers/webauthn.getCredentials
    events:
      - httpApi:
          path: /webauthn/credentials
          method: get

  webauthnDeleteCredential:
    handler: handlers/webauthn.deleteCredential
    events:
      - httpApi:
          path: /webauthn/credentials/{id}
          method: delete

  # ===== AUTH =====
  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post

  changePassword:
    handler: handlers/auth.changePassword
    events:
      - httpApi:
          path: /auth/change-password
          method: post

  refreshToken:
    handler: handlers/auth.refreshToken
    events:
      - httpApi:
          path: /auth/refresh
          method: post

  # ===== MFA =====
  initMFA:
    handler: handlers/mfa.initMFA
    events:
      - httpApi:
          path: /mfa/init
          method: post

  verifyMFA:
    handler: handlers/mfa.verifyMFA
    events:
      - httpApi:
          path: /mfa/verify
          method: post

  getMFAStatus:
    handler: handlers/mfa.getMFAStatus
    events:
      - httpApi:
          path: /mfa/status/{userId}
          method: get

  # ===== USERS =====
  createUser:
    handler: handlers/users.createUser
    events:
      - httpApi:
          path: /users
          method: post

  listUsers:
    handler: handlers/users.listUsers
    events:
      - httpApi:
          path: /users
          method: get

  disableUser:
    handler: handlers/users.disableUser
    events:
      - httpApi:
          path: /users/{id}/disable
          method: put

  resetUserPassword:
    handler: handlers/users.resetPassword
    events:
      - httpApi:
          path: /users/{id}/reset-password
          method: post

  # ===== DEBUG ENDPOINTS (for troubleshooting) =====
  debugGetAllUsers:
    handler: handlers/debug.getAllUsers
    events:
      - httpApi:
          path: /debug/users
          method: get

  debugGetUserByEmail:
    handler: handlers/debug.getUserByEmail
    events:
      - httpApi:
          path: /debug/user
          method: get

  debugGetUserByCognitoSub:
    handler: handlers/debug.getUserByCognitoSub
    events:
      - httpApi:
          path: /debug/cognito-sub/{cognito_sub}
          method: get

  debugTruncateUsers:
    handler: handlers/debug.truncateUsers
    events:
      - httpApi:
          path: /debug/truncate-users
          method: delete

  # ===== PATIENTS =====
  createPatient:
    handler: handlers/patients.create
    events:
      - httpApi:
          path: /patients
          method: post

  getPatient:
    handler: handlers/patients.getById
    events:
      - httpApi:
          path: /patients/{id}
          method: get

  searchPatients:
    handler: handlers/patients.search
    events:
      - httpApi:
          path: /patients/search
          method: get

  updatePatient:
    handler: handlers/patients.update
    events:
      - httpApi:
          path: /patients/{id}
          method: put

  # ===== PATIENT PORTAL =====
  getMyProfile:
    handler: handlers/patientPortal.getMyProfile
    events:
      - httpApi:
          path: /patients/me
          method: get

  getMyMedicalRecords:
    handler: handlers/patientPortal.getMyMedicalRecords
    events:
      - httpApi:
          path: /medical-records/me
          method: get

  getMyPrescriptions:
    handler: handlers/patientPortal.getMyPrescriptions
    events:
      - httpApi:
          path: /prescriptions/me
          method: get

  getMyVitalSigns:
    handler: handlers/patientPortal.getMyVitalSigns
    events:
      - httpApi:
          path: /vital-signs/me
          method: get

  # ===== VITAL SIGNS =====
  createVitalSigns:
    handler: handlers/vitalSigns.create
    events:
      - httpApi:
          path: /vital-signs
          method: post

  getVitalSigns:
    handler: handlers/vitalSigns.getByPatient
    events:
      - httpApi:
          path: /vital-signs/patient/{patientId}
          method: get

  getLatestVitalSigns:
    handler: handlers/vitalSigns.getLatest
    events:
      - httpApi:
          path: /vital-signs/patient/{patientId}/latest
          method: get

  # ===== MEDICAL RECORDS =====
  createMedicalRecord:
    handler: handlers/medicalRecords.create
    events:
      - httpApi:
          path: /medical-records
          method: post

  getMedicalRecord:
    handler: handlers/medicalRecords.getById
    events:
      - httpApi:
          path: /medical-records/{id}
          method: get

  getMedicalRecordsByPatient:
    handler: handlers/medicalRecords.getByPatient
    events:
      - httpApi:
          path: /medical-records/patient/{patientId}
          method: get

  updateMedicalRecord:
    handler: handlers/medicalRecords.update
    events:
      - httpApi:
          path: /medical-records/{id}
          method: put

  # ===== PRESCRIPTIONS =====
  createPrescription:
    handler: handlers/prescriptions.create
    events:
      - httpApi:
          path: /prescriptions
          method: post

  getPrescription:
    handler: handlers/prescriptions.getById
    events:
      - httpApi:
          path: /prescriptions/{id}
          method: get

  getPrescriptionsByPatient:
    handler: handlers/prescriptions.getByPatient
    events:
      - httpApi:
          path: /prescriptions/patient/{patientId}
          method: get

  # ===== AUDIT LOGS =====
  getAuditLogs:
    handler: handlers/auditLogs.getLogs
    events:
      - httpApi:
          path: /audit-logs
          method: get

  # ===== PATIENT FILES =====
  getUploadUrl:
    handler: handlers/patientFiles.getUploadUrl
    events:
      - httpApi:
          path: /patient-files/upload-url
          method: post

  saveFileMetadata:
    handler: handlers/patientFiles.saveFileMetadata
    events:
      - httpApi:
          path: /patient-files/metadata
          method: post

  getFilesByPatient:
    handler: handlers/patientFiles.getFilesByPatient
    events:
      - httpApi:
          path: /patient-files/patient/{patientId}
          method: get

  getDownloadUrl:
    handler: handlers/patientFiles.getDownloadUrl
    events:
      - httpApi:
          path: /patient-files/download/{fileId}
          method: get

  deleteFile:
    handler: handlers/patientFiles.deleteFile
    events:
      - httpApi:
          path: /patient-files/{fileId}
          method: delete

package:
  individually: false
  patterns:
    - "!.git/**"
    - "!test/**"
    - "!.env.example"
    - "!README.md"

resources:
  Resources:
    PatientFilesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ehr-backend-api-patient-files-dev
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - POST
              AllowedHeaders:
                - "*"
