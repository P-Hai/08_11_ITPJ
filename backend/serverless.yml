service: ehr-backend-api

frameworkVersion: "3"

useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  region: ap-southeast-1
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30

  environment:
    USER_POOL_ID: ${env:USER_POOL_ID}
    CLIENT_ID: ${env:CLIENT_ID}
    REGION: ${env:REGION}
    DB_HOST: ${env:DB_HOST}
    DB_PORT: ${env:DB_PORT}
    DB_NAME: ${env:DB_NAME}
    DB_USER: ${env:DB_USER}
    DB_PASSWORD: ${env:DB_PASSWORD}
    NODE_ENV: ${self:provider.stage}

  iam:
    role:
      statements:
        # SES Permissions
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: "*"

        # Cognito Permissions
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:ListUsers
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminAddUserToGroup
            - cognito-idp:AdminDisableUser
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:AdminListGroupsForUser
          Resource:
            - arn:aws:cognito-idp:${self:provider.region}:*:userpool/${env:USER_POOL_ID}

        # Secrets Manager
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource:
            - arn:aws:secretsmanager:${self:provider.region}:*:secret:ehr-system/*

        # CloudWatch Logs
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

  httpApi:
    cors:
      allowedOrigins:
        - "*"
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS

plugins:
  - serverless-offline
  - serverless-dotenv-plugin

functions:
  # Authentication
  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /auth/login
          method: post

  changePassword:
    handler: handlers/auth.changePassword
    events:
      - httpApi:
          path: /auth/change-password
          method: post

  refreshToken:
    handler: handlers/auth.refreshToken
    events:
      - httpApi:
          path: /auth/refresh
          method: post

  # Admin User Management
  createUser:
    handler: handlers/users.createUser
    events:
      - httpApi:
          path: /users
          method: post

  listUsers:
    handler: handlers/users.listUsers
    events:
      - httpApi:
          path: /users
          method: get

  disableUser:
    handler: handlers/users.disableUser
    events:
      - httpApi:
          path: /users/{id}/disable
          method: put

  resetUserPassword:
    handler: handlers/users.resetPassword
    events:
      - httpApi:
          path: /users/{id}/reset-password
          method: post

  # Patient Portal
  getMyProfile:
    handler: handlers/patientPortal.getMyProfile
    events:
      - httpApi:
          path: /patients/me
          method: get

  getMyMedicalRecords:
    handler: handlers/patientPortal.getMyMedicalRecords
    events:
      - httpApi:
          path: /medical-records/me
          method: get

  getMyPrescriptions:
    handler: handlers/patientPortal.getMyPrescriptions
    events:
      - httpApi:
          path: /prescriptions/me
          method: get

  getMyVitalSigns:
    handler: handlers/patientPortal.getMyVitalSigns
    events:
      - httpApi:
          path: /vital-signs/me
          method: get

  # Patients
  createPatient:
    handler: handlers/patients.create
    events:
      - httpApi:
          path: /patients
          method: post

  getPatient:
    handler: handlers/patients.getById
    events:
      - httpApi:
          path: /patients/{id}
          method: get

  searchPatients:
    handler: handlers/patients.search
    events:
      - httpApi:
          path: /patients/search
          method: get

  updatePatient:
    handler: handlers/patients.update
    events:
      - httpApi:
          path: /patients/{id}
          method: put

  # Vital Signs
  createVitalSigns:
    handler: handlers/vitalSigns.create
    events:
      - httpApi:
          path: /vital-signs
          method: post

  getVitalSigns:
    handler: handlers/vitalSigns.getByPatient
    events:
      - httpApi:
          path: /vital-signs/patient/{patientId}
          method: get

  getLatestVitalSigns:
    handler: handlers/vitalSigns.getLatest
    events:
      - httpApi:
          path: /vital-signs/patient/{patientId}/latest
          method: get

  # Medical Records
  createMedicalRecord:
    handler: handlers/medicalRecords.create
    events:
      - httpApi:
          path: /medical-records
          method: post

  getMedicalRecord:
    handler: handlers/medicalRecords.getById
    events:
      - httpApi:
          path: /medical-records/{id}
          method: get

  getMedicalRecordsByPatient:
    handler: handlers/medicalRecords.getByPatient
    events:
      - httpApi:
          path: /medical-records/patient/{patientId}
          method: get

  updateMedicalRecord:
    handler: handlers/medicalRecords.update
    events:
      - httpApi:
          path: /medical-records/{id}
          method: put

  # Prescriptions
  createPrescription:
    handler: handlers/prescriptions.create
    events:
      - httpApi:
          path: /prescriptions
          method: post

  getPrescription:
    handler: handlers/prescriptions.getById
    events:
      - httpApi:
          path: /prescriptions/{id}
          method: get

  getPrescriptionsByPatient:
    handler: handlers/prescriptions.getByPatient
    events:
      - httpApi:
          path: /prescriptions/patient/{patientId}
          method: get

  # Audit Logs
  getAuditLogs:
    handler: handlers/auditLogs.getLogs
    events:
      - httpApi:
          path: /audit-logs
          method: get

  # ============================================
  # MFA FUNCTIONS
  # ============================================
  initMFA:
    handler: handlers/mfa.initMFA
    events:
      - httpApi:
          path: /mfa/init
          method: post

  verifyMFA:
    handler: handlers/mfa.verifyMFA
    events:
      - httpApi:
          path: /mfa/verify
          method: post

  getMFAStatus:
    handler: handlers/mfa.getMFAStatus
    events:
      - httpApi:
          path: /mfa/status/{userId}
          method: get

package:
  individually: false
  patterns:
    - "!.git/**"
    - "!test/**"
    - "!.env.example"
    - "!README.md"
